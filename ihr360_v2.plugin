#!name = iäººäº‹è€ƒå‹¤å…¨è‡ªåŠ¨åŠ©æ‰‹
#!desc = ã€ITå‰¯ç»ç†ä¸“ç”¨ã€‘æ”¯æŒè‡ªåŠ¨æŠ“å–ä¸ä½ç½®åŠ«æŒã€‚åœ¨å…¬å¸æ—¶å¼€å¯â€œæŠ“å–æ¨¡å¼â€æ‰“å¡ä¸€æ¬¡ï¼Œä¹‹ååœ¨ä»»ä½•åœ°æ–¹å…³é—­å¼€å…³å³å¯å®ç°åŠ«æŒæ‰“å¡ã€‚
#!author = Gemini
#!icon = https://raw.githubusercontent.com/lpdshare/loon-icon/master/i-rensari.png

# --- æ’ä»¶é…ç½®é¡¹ ---
[Argument]
captureMode = switch, false, tag=æŠ“å–æ¨¡å¼å¼€å…³, desc=åœ¨å…¬å¸æ—¶è¯·å¼€å¯æ­¤å¼€å…³ä»¥å½•åˆ¶åŠ å¯†åŒ…

# --- åŸŸåè§£å¯† ---
[MITM]
hostname = www.ihr360.com

# --- è„šæœ¬è§¦å‘è§„åˆ™ ---
[Script]
# ä½¿ç”¨å†…éƒ¨è„šæœ¬æ–¹å¼ï¼ŒåŒ¹é…æ‰“å¡æ ¸å¿ƒè§£ç æ¥å£
http-request ^https:\/\/www\.ihr360\.com\/gateway\/attendance\/sign\/attendanceSign\/doSign\/decode script-path=https://raw.githubusercontent.com/your_user/your_repo/main/ihr360_v2.plugin, requires-body=true, argument={captureMode}, tag=iäººäº‹è‡ªåŠ¨é€»è¾‘

# --- æ ¸å¿ƒé€»è¾‘è„šæœ¬ (å†…åµŒ) ---
/**
 * æ ¸å¿ƒé€»è¾‘ï¼šè‡ªåŠ¨æŒä¹…åŒ–å­˜å‚¨ä¸åŠ å¯†åŒ…æ›¿æ¢
 */
#!here
const url = $request.url;
const body = $request.body;
// è·å–æ’ä»¶é¢æ¿ä¸Šçš„å¼€å…³çŠ¶æ€
const isCaptureMode = $argument.captureMode === "true";

if (url.indexOf("doSign/decode") !== -1 && body) {
    let obj;
    try {
        obj = JSON.parse(body);
    } catch (e) {
        $notification.post("iäººäº‹åŠ©æ‰‹", "è§£æå¤±è´¥", "è¯·æ±‚ä½“ä¸æ˜¯åˆæ³•çš„JSONæ ¼å¼");
        $done({});
    }

    if (isCaptureMode) {
        // --- å½•åˆ¶æ¨¡å¼ï¼šåœ¨å…¬å¸ä½¿ç”¨ ---
        let currentPayload = obj.aesReq;
        if (currentPayload) {
            // å°†åŠ å¯†åŒ…æ°¸ä¹…å­˜å…¥æœ¬åœ°ç¼“å­˜
            $persistentStore.write(currentPayload, "ihr_gold_payload");
            
            $notification.post("iäººäº‹åŠ©æ‰‹", "âœ… åŠ å¯†åŒ…å½•åˆ¶æˆåŠŸ", "å·²å­˜å…¥Loonæœ¬åœ°ç¼“å­˜ï¼Œä»¥åæ‰“å¡å°†è‡ªåŠ¨ä½¿ç”¨æ­¤åŒ…");
            console.log("ğŸ”” [å½•åˆ¶ä¸­] æ•è·åˆ° Payload: " + currentPayload);
        }
        $done({}); // å½•åˆ¶æ—¶æ­£å¸¸å‘å‡ºè¯·æ±‚ï¼Œä¸å½±å“æœ¬æ¬¡æ‰“å¡
    } else {
        // --- åŠ«æŒæ¨¡å¼ï¼šåœ¨å¼‚åœ°ä½¿ç”¨ ---
        let savedPayload = $persistentStore.read("ihr_gold_payload");
        
        if (savedPayload) {
            obj.aesReq = savedPayload;
            console.log("ğŸš€ [åŠ«æŒä¸­] æ­£åœ¨æ³¨å…¥æœ¬åœ°é¢„å­˜çš„é»„é‡‘åŠ å¯†åŒ…...");
            // å‘é€é€šçŸ¥æé†’ï¼Œç¡®ä¿ä½ çŸ¥é“è„šæœ¬åœ¨å·¥ä½œ
            $notification.post("iäººäº‹åŠ©æ‰‹", "ğŸ›  ä½ç½®åŠ«æŒå·²ç”Ÿæ•ˆ", "å·²æ›¿æ¢ä¸ºé¢„å­˜çš„å…¬å¸åŠ å¯†æ•°æ®");
            $done({ body: JSON.stringify(obj) });
        } else {
            $notification.post("iäººäº‹åŠ©æ‰‹", "âŒ åŠ«æŒå¤±è´¥", "æœ¬åœ°æ— é¢„å­˜æ•°æ®ï¼Œè¯·å…ˆåœ¨å…¬å¸å¼€å¯æŠ“å–æ¨¡å¼æ‰“ä¸€æ¬¡å¡");
            $done({});
        }
    }
} else {
    $done({});
}
