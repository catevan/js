#!name = iäººäº‹è€ƒå‹¤åŠ©æ‰‹(è‡ªåŠ¨ç‰ˆ)
#!desc = ã€ITå‰¯ç»ç†ä¸“ç”¨ã€‘æ”¯æŒè‡ªåŠ¨æŠ“å–ä¸ä½ç½®åŠ«æŒã€‚åœ¨å…¬å¸æ—¶å¼€å¯â€œæŠ“å–æ¨¡å¼â€æ‰“å¡ä¸€æ¬¡ï¼Œä¹‹ååœ¨ä»»ä½•åœ°æ–¹å…³é—­å¼€å…³å³å¯å®ç°åŠ«æŒæ‰“å¡ã€‚
#!author = Gemini
#!icon = https://raw.githubusercontent.com/lpdshare/loon-icon/master/i-rensari.png

# --- æ’ä»¶é…ç½®é¡¹ ---
[Argument]
captureMode = switch, false, tag=æŠ“å–æ¨¡å¼å¼€å…³, desc=åœ¨å…¬å¸æ—¶è¯·å¼€å¯æ­¤å¼€å…³ä»¥å½•åˆ¶åŠ å¯†åŒ…

# --- åŸŸåè§£å¯† ---
[MITM]
hostname = www.ihr360.com

# --- è„šæœ¬è§¦å‘è§„åˆ™ ---
[Script]
# ç¡®ä¿å¼•ç”¨çš„æ˜¯è¿™ä¸ªæ–‡ä»¶æœ¬èº«çš„ Raw é“¾æ¥
http-request ^https:\/\/www\.ihr360\.com\/gateway\/attendance\/sign\/attendanceSign\/doSign\/decode script-path=https://raw.githubusercontent.com/catevan/js/refs/heads/main/ihr360_v2.plugin, requires-body=true, argument={captureMode}, tag=iäººäº‹è‡ªåŠ¨é€»è¾‘

# --- æ ¸å¿ƒé€»è¾‘è„šæœ¬ (å†…åµŒ) ---
#!here
/**
 * æ ¸å¿ƒé€»è¾‘ï¼šè‡ªåŠ¨æŒä¹…åŒ–å­˜å‚¨ä¸åŠ å¯†åŒ…æ›¿æ¢
 */
(function() {
    // å¢åŠ å®¹é”™ï¼šç¡®ä¿åªåœ¨æœ‰è¯·æ±‚æ—¶è¿è¡Œ
    if (typeof $request === 'undefined') return $done({});

    const url = $request.url;
    const body = $request.body;
    
    // ä¸¥è°¨è·å–å‚æ•°é€»è¾‘
    let isCaptureMode = false;
    if (typeof $argument !== 'undefined' && $argument) {
        // å¤„ç†ä¸åŒç‰ˆæœ¬ Loon å¯¹ argument çš„è§£æå·®å¼‚
        isCaptureMode = (String($argument.captureMode) === "true");
    }

    if (url.indexOf("doSign/decode") !== -1 && body) {
        let obj;
        try {
            obj = JSON.parse(body);
        } catch (e) {
            $notification.post("iäººäº‹åŠ©æ‰‹", "è§£æå¤±è´¥", "è¯·æ±‚ä½“ä¸æ˜¯åˆæ³•çš„JSONæ ¼å¼");
            return $done({});
        }

        if (isCaptureMode) {
            // --- å½•åˆ¶æ¨¡å¼ï¼šåœ¨å…¬å¸ä½¿ç”¨ ---
            let currentPayload = obj.aesReq;
            if (currentPayload) {
                $persistentStore.write(currentPayload, "ihr_gold_payload");
                $notification.post("iäººäº‹åŠ©æ‰‹", "âœ… åŠ å¯†åŒ…å½•åˆ¶æˆåŠŸ", "å·²å­˜å…¥Loonæœ¬åœ°ç¼“å­˜");
                console.log("ğŸ”” [å½•åˆ¶ä¸­] æ•è·åˆ° Payload");
            }
            $done({});
        } else {
            // --- åŠ«æŒæ¨¡å¼ï¼šåœ¨å¼‚åœ°ä½¿ç”¨ ---
            let savedPayload = $persistentStore.read("ihr_gold_payload");
            if (savedPayload) {
                obj.aesReq = savedPayload;
                $notification.post("iäººäº‹åŠ©æ‰‹", "ğŸ›  ä½ç½®åŠ«æŒå·²ç”Ÿæ•ˆ", "å·²æ›¿æ¢ä¸ºé¢„å­˜çš„å…¬å¸åŠ å¯†æ•°æ®");
                $done({ body: JSON.stringify(obj) });
            } else {
                $notification.post("iäººäº‹åŠ©æ‰‹", "âŒ åŠ«æŒå¤±è´¥", "æœ¬åœ°æ— é¢„å­˜æ•°æ®ï¼Œè¯·å…ˆåœ¨å…¬å¸å¼€å¯æŠ“å–æ¨¡å¼");
                $done({});
            }
        }
    } else {
        $done({});
    }
})();
